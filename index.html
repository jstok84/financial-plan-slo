<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finančni Načrt</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f6fa;
        }

        .form-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
        }

        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 16px;
        }

        button {
            background-color: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
        }

        button:hover {
            background-color: #2980b9;
        }

        .error {
            color: red;
            font-size: 0.9em;
            margin-top: 5px;
        }

        #debug {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
    </style>
</head>
<body>
    <form id="financialForm">
        <div class="form-section">
            <h2>Osebni podatki</h2>
            <label for="age">Starost:</label>
            <input type="number" id="age" required>
            <div class="error" id="ageError"></div>

            <label for="income">Mesečni prihodki (€):</label>
            <input type="number" id="income" required>
            <div class="error" id="incomeError"></div>
        </div>

        <div class="form-section">
            <h2>Trenutno stanje</h2>
            <label for="savings">Prihranki (€):</label>
            <input type="number" id="savings" required>
            <div class="error" id="savingsError"></div>

            <label for="current_property">Imate trenutno nepremičnino?</label>
            <select id="current_property">
                <option value="da">Da</option>
                <option value="ne">Ne</option>
            </select>
        </div>

        <div class="form-section">
            <h2>Mesečni stroški</h2>
            <label for="food">Prehrana (€):</label>
            <input type="number" id="food" required>
            <div class="error" id="foodError"></div>

            <label for="utilities">Komunalni stroški (€):</label>
            <input type="number" id="utilities" required>
            <div class="error" id="utilitiesError"></div>

            <label for="transport">Stroški prevoza (€):</label>
            <input type="number" id="transport" required>
            <div class="error" id="transportError"></div>

            <label for="insurance">Zavarovanja (€):</label>
            <input type="number" id="insurance" required>
            <div class="error" id="insuranceError"></div>

            <label for="other_expenses">Ostali stroški (€):</label>
            <input type="number" id="other_expenses" required>
            <div class="error" id="other_expensesError"></div>
        </div>

        <div class="form-section">
            <h2>Hipotekarno posojilo</h2>
            <label for="loan_amount">Želeno znesek posojila (€):</label>
            <input type="number" id="loan_amount" required>
            <div class="error" id="loan_amountError"></div>

            <label for="loan_term">Načrtovano obdobje (leta):</label>
            <input type="number" id="loan_term" required>
            <div class="error" id="loan_termError"></div>

            <label for="interest_rate">Očakovana obrestna mera (%):</label>
            <input type="number" step="0.1" id="interest_rate" required>
            <div class="error" id="interest_rateError"></div>
        </div>

        <button type="submit">Izračunaj</button>
        <button type="button" id="generatePdf">Generiraj PDF</button>
    </form>

    <div id="debug"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Debug funkcija
        function debug(message) {
            const debugDiv = document.getElementById('debug');
            debugDiv.style.display = 'block';
            debugDiv.textContent = message;
            console.log(message);
        }

        // Validacija obrazca
        function validateForm() {
            let isValid = true;
            const errors = {
                age: 'Vnesite veljavno starost (18-100)',
                income: 'Vnesite pozitivno vrednost',
                savings: 'Vnesite pozitivno vrednost',
                food: 'Vnesite pozitivno vrednost',
                utilities: 'Vnesite pozitivno vrednost',
                transport: 'Vnesite pozitivno vrednost',
                insurance: 'Vnesite pozitivno vrednost',
                other_expenses: 'Vnesite pozitivno vrednost',
                loan_amount: 'Vnesite pozitivno vrednost',
                loan_term: 'Vnesite število let (1-30)',
                interest_rate: 'Vnesite obrestno mero (1-10%)'
            };

            // Preveri starost
            const age = parseInt(document.getElementById('age').value);
            if (age < 18 || age > 100) {
                showError('age', errors.age);
                isValid = false;
            } else {
                hideError('age');
            }

            // Preveri vse pozitivne vrednosti
            ['income', 'savings', 'food', 'utilities', 'transport', 
             'insurance', 'other_expenses', 'loan_amount'].forEach(id => {
                const value = parseFloat(document.getElementById(id).value);
                if (value <= 0) {
                    showError(id, errors[id]);
                    isValid = false;
                } else {
                    hideError(id);
                }
            });

            // Preveri obdobje posojila
            const loan_term = parseInt(document.getElementById('loan_term').value);
            if (loan_term < 1 || loan_term > 30) {
                showError('loan_term', errors.loan_term);
                isValid = false;
            } else {
                hideError('loan_term');
            }

            // Preveri obrestno mero
            const interest_rate = parseFloat(document.getElementById('interest_rate').value);
            if (interest_rate < 1 || interest_rate > 10) {
                showError('interest_rate', errors.interest_rate);
                isValid = false;
            } else {
                hideError('interest_rate');
            }

            return isValid;
        }

        // Prikaz napake
        function showError(id, message) {
            document.getElementById(`${id}Error`).textContent = message;
            debug(`Error in ${id}: ${message}`);
        }

        // Skrij napako
        function hideError(id) {
            document.getElementById(`${id}Error`).textContent = '';
        }

        // Izračun mesečne obremenitve
        function calculateMonthlyBurden() {
            try {
                const formData = new FormData(document.getElementById('financialForm'));
                const data = Object.fromEntries(formData.entries());

                // Izračun mesečne obremenitve
                const monthlyExpenses = parseInt(data.food) + 
                                     parseInt(data.utilities) + 
                                     parseInt(data.transport) + 
                                     parseInt(data.insurance) + 
                                     parseInt(data.other_expenses);

                // Izračun mesečne obrestne mere
                const monthlyInterestRate = parseFloat(data.interest_rate) / 100 / 12;
                
                // Izračun števila plačil
                const numberOfPayments = parseInt(data.loan_term) * 12;
                
                // Izračun mesečne rate
                const monthlyPayment = (parseFloat(data.loan_amount) * monthlyInterestRate * 
                                     Math.pow(1 + monthlyInterestRate, numberOfPayments)) / 
                                    (Math.pow(1 + monthlyInterestRate, numberOfPayments) - 1);

                debug(`Calculations successful:
                    Monthly expenses: ${monthlyExpenses}
                    Monthly payment: ${monthlyPayment}`);

                return {
                    monthlyExpenses,
                    monthlyPayment
                };
            } catch (error) {
                debug(`Error in calculation: ${error.message}`);
                throw error;
            }
        }

        // Generiranje PDF poročila
        function generatePdf() {
            try {
                const calculations = calculateMonthlyBurden();
                
                const doc = new jsPDF();
                doc.setFontSize(15);
                doc.text('Finančni Načrt', 105, 30, null, null, 'center');
                
                doc.setFontSize(12);
                doc.text(`Mesečni stroški: €${calculations.monthlyExpenses.toFixed(2)}`, 20, 50);
                doc.text(`Mesečna rata: €${calculations.monthlyPayment.toFixed(2)}`, 20, 60);
                
                const formData = new FormData(document.getElementById('financialForm'));
                const data = Object.fromEntries(formData.entries());
                
                doc.text(`Želeno posojilo: €${data.loan_amount}`, 20, 70);
                doc.text(`Obdobje: ${data.loan_term} let`, 20, 80);
                doc.text(`Obrestna mera: ${data.interest_rate}%`, 20, 90);
                
                debug('PDF generated successfully');
                doc.save('financni_nacrt.pdf');
            } catch (error) {
                debug(`Error generating PDF: ${error.message}`);
                alert('Napaka pri generiranju PDF poročila. Preverite vnosne podatke.');
            }
        }

        // Dodajanje poslušalcev dogodkov
        document.getElementById('financialForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (validateForm()) {
                try {
                    const calculations = calculateMonthlyBurden();
                    debug('Calculation successful');
                    alert(`Mesečni stroški: €${calculations.monthlyExpenses.toFixed(2)}\n` +
                          `Mesečna rata: €${calculations.monthlyPayment.toFixed(2)}`);
                } catch (error) {
                    debug(`Calculation error: ${error.message}`);
                    alert('Napaka pri izračunu. Preverite vnosne podatke.');
                }
            }
        });

        document.getElementById('generatePdf').addEventListener('click', generatePdf);
    </script>
</body>
</html>
